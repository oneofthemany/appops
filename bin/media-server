#!/bin/bash

BINDIR=$(dirname $(realpath ${BASH_SOURCE[0]}))
ROOTDIR=$(realpath ${BINDIR}/..)

source ${BINDIR}/.helpers       # helpful script functions
source ${BINDIR}/../etc/conf.sh # user configuration

## setup

NGX="nginx -p ${ROOTDIR} -c etc/nginx.conf"
NGX_PID=${RUNDIR}/nginx.pid
NGX_GLOBALS="pid ${NGX_PID}; error_log ${LOGDIR}/nginx-error.log;"

if [[ ${HTTP_PORT} -lt 1024 ]]; then
  NGX="sudo ${NGX}"
  NGX_GLOBALS="${NGX_GLOBALS} user ${NGX_USER};"
fi

## commands

function start() {
  # dynamic config for the http directive
  (cat <<EOCONF
# DO NOT EDIT; GENERATED BY bin/ngx
upstream websocket {
    server 127.0.0.1:${WEBSOCKET_PORT};
}

# needed when running nginx as non-root
client_body_temp_path ${TMPDIR}/nginx;
fastcgi_temp_path     ${TMPDIR}/nginx;
uwsgi_temp_path       ${TMPDIR}/nginx;
scgi_temp_path        ${TMPDIR}/nginx;
proxy_temp_path       ${TMPDIR}/nginx;
EOCONF
  ) > ${ROOTDIR}/etc/nginx.http.conf

  # dynamic config for the listener directive
  (cat <<EOCONF
# DO NOT EDIT; GENERATED BY bin/ngx
listen ${HTTP_PORT} default_server sndbuf=32k;
EOCONF
  ) > ${ROOTDIR}/etc/nginx.listen.conf

  # run nginx
  ${NGX} -g "${NGX_GLOBALS}"
  log "# nginx running with pid=$(cat ${NGX_PID})"
}

function stop() {
  log "# stopping nginx"
  ${NGX} -g "${NGX_GLOBALS}" -s stop
}

## usage

function usage () {
  read -r -d '' HELP <<EOHELP
Usage: ${0} [OPTIONS] COMMAND

Options:
  -h, --help\tThis help message

Commands:
  start\t\tStart this service
  stop \t\tStop this service
EOHELP
  die "${1}\n${HELP}"
}

## main

function main() {
  eval set -- `getopt -o h --long help -n "${0}" -- "$@"`

  while [ ! -z "${1}" ]; do
    case "${1}" in
      -h|--help) usage;;
      --) shift; break;;
      *) usage;;
    esac

    shift
  done

  case "${1}" in
    start)
      start;;
    stop)
      stop;;
    *) usage "! Unknown command '${1}'\n";;
  esac
}

main ${@}
